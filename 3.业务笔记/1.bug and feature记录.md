#工作笔记
***
##1. Feature

###1.1 Driverless audio enable or disable according to APP 
_2019-4-12_

**description:**
for this requirement in Driver-less Project, we need fw support following two commands, I have modified the protocol for Create Audio Device and Query Audio Settings, attached is new protocol.
（关键词：Driver-less Project，commands，protocol）
根据要求，在`smiconsumer.c`中的`Commander`函数中根据协议新增的两条命令分别实现以下功能：
0.audio_status，
1.创建audio设备，
2. 
![CONTROL_CREATE_AUDIO_DEVICE/0x4f](control_create_audio_device.png)
![QUERY_AUDIO_DEVICE_SETTING/0x78](query_audio_device_setting.png)
![Description](humi_audio_default_off.png)
HDMI plug_in:host send `"enable audio"` cmd to fw,the fw will reset itselt and report both general and audio device.

**协议版本(smiprotocol.h)：**
>#define SMI_PROTOCOL_VERSION_NUM ("3.01")//new,1029lines
>#define SMI_PROTOCOL_VERSION_NUM ("2.20")//local,1446lines

**SMIPTC_DATA_TYPE(smiprotocol.h)：**
>CONTROL_CREATE_AUDIO_DEVICE = 0x4f
>QUERY_AUDIO_DEVICE_SETTING = 0x78

**结构体定义**

    typedef struct _AUDIO_STATUS_
    {
        _SMI_PROTOCOL_UCHAR_ CreateAudioDeviceOrNot;   // 0x1: create audio device;  0x0: not create audio device
        union
        {
            struct
            {
                _SMI_PROTOCOL_UCHAR_    DVI0_AUDIO_OUTPUT : 1;         // 0x01
                _SMI_PROTOCOL_UCHAR_    EXTERNAL_CODEC_OUTPUT : 1;    // 0x02
                _SMI_PROTOCOL_UCHAR_    HDMI_AUDIO_OUTPUT : 1;       // 0x04
                _SMI_PROTOCOL_UCHAR_    DP_AUDIO_OUTPUT : 1;    // 0x08
                _SMI_PROTOCOL_UCHAR_    Reserved : 4;    // 0xF0
            };
            //0x4: Output audio from HDMI;  0x8: output audio from DP; 0x1: output audio from DVI; 0x2: output to audio external codec
            _SMI_PROTOCOL_UCHAR_        AudioOutput;
        };
    }AUDIO_STATUS
    
    typedef struct _SMIPTC_CONTROL_CREATE_AUDIO_DEVICE_
    {
        SMIPTC_OPERATION operation;
        _SMI_PROTOCOL_UCHAR_ DataType;
        AUDIO_STATUS  AudioStatus;
    }SMIPTC_CONTROL_CREATE_AUDIO_DEVICE;



new ocde:`smiconsumer.h`line 2956


##2. Bug
###2.1  On mac platform, do HDMI/CRT PnP, wait more than 3 minutes, the view can be disappear or create.
```
/* Start SMI decode */->
SmiHardDecode((void *)InputStreamAddr, InputStreamLength, &dest, ViewIndex);->
SM768_YUVBlit_4KPMode((ul32)InputStreamAddr, view->ovlSrcAddr_YUV.bufYAddr);->
sb_IRQVectSet(SB_IRQ_VAL_DMA, Dma_Isr1),sb_IRQVectSet(SB_IRQ_VAL_DMA, Dma_Isr);->
sb_OS_LSR_INVOKE(DMA1CarryDone_LSR, 0),sb_OS_LSR_INVOKE(DMA1DecodeDone_LSR, 0);->

计算DMA1DecodeDone_LSR与DMA1CarryDone_LSR执行时间，

```
    LSR时间测试：
    extern unsigned long time_start,time_end;

	if(time_start==1){
		audio_lsr_start=timerGetCounter(TIMER_1);
	}

    if(time_start==1&&time_end==0){
        audio_lsr_end=timerGetCounter(TIMER_1);
        audio_t_sum+=audio_lsr_start-audio_lsr_end;
        if(lsr_i<=20){
            plsr_timer[lsr_i]=(audio_lsr_start-audio_lsr_end);
            lsr_i++;
        }
    }

    /*LSR运行时间测试结构体*/
    typedef struct LSR_time{
        unsigned long lsr_start; 
        unsigned long lsr_end;
        //结构体类型的静态成员变量的初始化问题
        static unsigned long lsr_sum_time;
        static unsigned long lsr_i;
        static unsigned long lsr_list_time[20];
    }LSR_time={0,0,0,0},{0};


    EDID测试：
    MonitorPNP_Task = smx_TaskCreate((FUN_PTR)MonitorPNP, PRI_LOWER, PNP_STACK_SIZE, SMX_FL_NONE, "PNP");
    edidRet = Get_EDID_Data(edidbuf, MONITOR_CRT1);
    edidRet = readEDIDandUpdateModeList(EDID_SIZE, targetID);
    ret =  SM768_detectEdidExSwI2C(
            gHDMIContext.pEdidBuffer,
            edidBufferSize,
            0,
            DEFAULT_I2CS_SCL,
            DEFAULT_I2CS_SDA);
    swI2CReadReg_Continuous(EDID_DEVICE_I2C_ADDRESS, 0,TOTAL_EDID_REGISTERS_128,edidBuffer);
    swI2CStart();
    swI2CSCL(1);//ul retry_scl = 100000;



***
#Markdown笔记
https://blog.csdn.net/u014061630/article/details/81359144
##标题
六级标题
##插入图片